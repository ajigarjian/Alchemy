{% extends "internal/internal.html" %}

{% block body %}

<div class="body_wrapper flex">

    <div class="flex flex-col h-screen hidden md:block p-4 text-center sticky top-0">
        <ul class="h-full flex flex-col text-left">
            {% for family in control_families %}
            <li class="py-2">
                <a href="{% url 'alchemy:implementation' system.name family.family_name %}" class="hover:text-blue-700 block {% if family == control_family %}text-blue-700 {%else%} text-gray-500 {% endif %}">
                    <span class="text-sm">{{ family.family_abbreviation }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div id="wizard_container" class="py-8 flex flex-col items-center justify-center min-h-screen flex-grow">
    
        <div id="family_header_box" class="overview_form w-4/5 xl:w-256 bg-white p-10 rounded-lg shadow-lg mb-12">
            
            <div id="family_header" class="text-center">
                <h1 class="text-2xl sm:text-4xl font-black tracking-wide text-blue-600 mb-2">{{control_family}}</h1>
            </div>

        </div>

        <div id="controls_box" class="w-4/5 xl:w-256 mb-12">

            {% for implementation in control_implementations %}
            <div class="mb-48">
                <div id="control_header">
                    <h1 class="text-2xl font-black tracking-wide text-blue-600 mb-2">{{implementation.control}} {{implementation.control.control_name }}</h1>
                </div>
                <div id="control_requirement">
                    <div id="control_description-{{implementation.control.id}}" class="relative line-clamp-3 text-blue-600">
                        <p>{{implementation.control.control_description}}</p>
                        {% if implementation.control.control_description|length > 350 %}
                            <div id="show-gradient" class="absolute bottom-0 left-0 right-0 h-12 show-more-gradient"></div>
                        {% endif %}
                    </div>

                    {% if implementation.control.control_description|length > 350 %}
                    <div class="flex justify-center mt-2">
                        <button type="button" data-id="{{implementation.control.id}}" class="show-more-less-btn font-bold text-blue-700 hover:text-blue-800 transition-colors duration-300">
                            Show more
                        </button>
                    </div>                    
                    {% endif %}

                </div>



                <div id="control_guidance" class="mt-4">
                    <div id="accordion-flush" data-accordion="open" data-active-classes="text-white bg-blue-500" data-inactive-classes="text-gray-500">
    
                        <div id="accordion-guidance-element-{{implementation.control.id}}">
                            <h2 id="accordion-guidance-heading-{{implementation.control.id}}">
                                <button type="button" class="flex items-center justify-between w-full px-4 py-2 rounded-t-lg font-medium text-left text-gray-500" data-accordion-target="#accordion-guidance-body-{{implementation.control.id}}" aria-expanded="false" aria-controls="accordion-guidance-body-{{implementation.control.id}}">
                                    <span class="text-xl font-bold transition-transform duration-200">Supplemental Guidance</span> 
                                    <i data-accordion-icon class="fas fa-chevron-down w-6 h-6 transition-transform duration-200"></i>
                                </button>
                              </h2>
                              <div id="accordion-guidance-body-{{implementation.control.id}}" class="px-4 mt-2 hidden" aria-labelledby="accordion-guidance-heading-{{implementation.control.id}}">
                                <div class="px-8 py-6 ">
                                    <p class="mb-2 text-gray-500">{{implementation.control.supplemental_guidance}}</p>
                                </div>
                              </div>
                        </div>
                    
                        <div id="accordion-examples-element-{{implementation.control.id}}">
                            <h2 id="accordion-examples-heading-{{implementation.control.id}}">
                                <button type="button" class="flex items-center justify-between w-full px-4 py-2 font-medium text-left text-gray-500" data-accordion-target="#accordion-examples-body-{{implementation.control.id}}" aria-expanded="false" aria-controls="accordion-examples-body-{{implementation.control.id}}">
                                    <span class="text-xl font-bold transition-transform duration-200">Description Examples</span> 
                                    <i data-accordion-icon class="fas fa-chevron-down w-6 h-6 transition-transform duration-200"></i>
                                </button>
                              </h2>
                              <div id="accordion-examples-body-{{implementation.control.id}}" class="px-4 mt-2 hidden" aria-labelledby="accordion-examples-heading-{{implementation.control.id}}">
                                <div class="px-8 py-6 ">
                                    <p id="output-{{implementation.control.id}}" class="mb-2 text-gray-500">Refresh the Generate button to view sample language!</p>
                                
                                    <form id="openai-form" data-id="{{implementation.control.id}}" data-description="{{implementation.control.control_description}}" onsubmit="openAICall(event)">
                                        <button type="submit" class="m-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                            Generate
                                        </button>
                                    </form>
                                </div>
                                
                              </div>
                        </div>
                    
                    </div>
                </div>

                <div id="control_solution">
                </div>

                <div id="control_status">
                    <h2 class="text-xl font-bold text-gray-500 mt-4 mb-2">Implementation Status</h2> 

                    <ul class="grid w-full gap-x-2 gap-y-2 grid-cols-2 sm:grid-cols-3 xl:grid-cols-5">
                        {% for choice in implementation_choices %}
                            <li>
                                <input id="implementation-checkbox-{{implementation.id}}-{{choice.id}}" type="checkbox" value="{{choice.status}}" class="hidden" onchange="updateImplementationStatus(this, {{implementation.id}}, {{choice.id}})" required=""
                                    {% for status in implementation.statuses.all %}
                                        {% if status.id == choice.id %}
                                            checked
                                        {% endif %}
                                    {% endfor %}>
                                <label for="implementation-checkbox-{{implementation.id}}-{{choice.id}}" class="inline-flex items-center justify-between w-full px-2 py-1 text-gray-500 bg-white rounded cursor-pointer hover:text-white hover:bg-blue-700 transition duration-200">
                                    <div class="block w-full text-center text-xs flex items-center justify-center">
                                        {% if choice.status == "Alternative Implementation" %}
                                            Alt. Implementation
                                        {% else %}
                                            {{choice.status}}
                                        {% endif %}
                                    </div>
                                </label>
                            </li>
                         {% endfor %}
                    </ul>
                </div>

                <div id="control_origination">
                    <h2 class="text-xl font-bold text-gray-500 mt-4 mb-2">Control Origination</h2> 

                    <ul class="grid w-full gap-x-2 gap-y-2 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                        {% for choice in origination_choices %}
                            <li>
                                <input id="origination-checkbox-{{implementation.id}}-{{choice.id}}" type="checkbox" value="{{choice.origination}}" class="hidden"  onchange="updateOriginationStatus(this, {{implementation.id}}, {{choice.id}})" required=""
                                    {% for origination in implementation.originations.all %}
                                        {% if origination.id == choice.id %}
                                            checked
                                        {% endif %}
                                    {% endfor %}>
                                <label for="origination-checkbox-{{implementation.id}}-{{choice.id}}" class="inline-flex items-center justify-between w-full px-2 py-1 text-gray-500 bg-white rounded cursor-pointer hover:text-white hover:bg-blue-700 transition duration-200">
                                    <div class="block w-full text-center text-xs flex items-center justify-center">
                                            {{choice.origination}}
                                    </div>
                                </label>
                            </li>
                         {% endfor %}
                    </ul>
                </div>

            </div>

            {% endfor %}

        </div>

        <button id ="scrollButton" class="fixed right-8 bottom-8 bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">
            <i id="scrollIcon" class="fas fa-chevron-down"></i>
        </button>

        <div id="toast-success" class="fixed transition opacity-0 duration-300 bottom-4 flex items-center w-24 max-w-s p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
            <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 mr-2 text-green-500 bg-green-100 rounded-lg dark:bg-green-800 dark:text-green-200">
                <i class="fas fa-check"></i>
                <span class="sr-only">Check icon</span>
            </div>
            <div class="ml-3 text-sm font-normal">Item moved successfully.</div>
            <button type="button" class="flex justify-center items-center ml-2 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-success" aria-label="Close">
                <span class="sr-only">Close</span>
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
  
    </div>
</div>
  
<!-- Javascript for interactive aspects of the onboarding wizard -->
<script type="text/javascript">

    // Scrolling function for category selection view. When the circular scroll button in bottom right is clicked, it will either scroll down or up to show more of the categories
    document.getElementById("scrollButton").addEventListener("click", function() {
        const scrollButton = document.getElementById("scrollButton");
        const scrollIcon = document.getElementById("scrollIcon");

        // If the arrow is pointing down, it targets the new position which is one window-height down, and scrolls to it
        if (scrollIcon.classList.contains("fa-chevron-down")) {
            // Calculate the target scroll position, which is one viewport height from the current scroll position.
            const targetScrollPosition = window.pageYOffset + window.innerHeight;
            
            // Scroll to the target scroll position smoothly.
            window.scrollTo({
                top: targetScrollPosition,
                behavior: "smooth",
            });
        // Otherwise, it scrolls back to the top (implying the arrow is pointing up)
        } else {
            window.scrollTo({ top: 0, behavior: "smooth" });
        }
    })

    // Second scrolling function for category selection view. Responsible for changing the arrow in the icon to up and down depending on where the user is vertically. 
    window.addEventListener("scroll", () => {
        const scrollButton = document.getElementById("scrollButton");
        const scrollIcon = document.getElementById("scrollIcon");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop;

        // When the user is near or at the bottom of the page, switches chevron to up, otherwise it will be pointing down
        if (scrollHeight - clientHeight - scrollTop < 5) {
            scrollIcon.classList.remove("fa-chevron-down");
            scrollIcon.classList.add("fa-chevron-up");
        } else {
            scrollIcon.classList.remove("fa-chevron-up");
            scrollIcon.classList.add("fa-chevron-down");
        }
    });

    // Functionality for show more/show less text expansion/compression and fade in/out
    document.querySelectorAll('.show-more-less-btn').forEach((btn) => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const descriptionDiv = document.querySelector('#control_description-' + id);
            const gradientDiv = descriptionDiv.querySelector('#show-gradient');
            if (this.innerText === 'Show more') {
                descriptionDiv.classList.remove('line-clamp-3');
                this.innerText = 'Show less';
                gradientDiv.classList.remove('show-more-gradient');
            } else {
                descriptionDiv.classList.add('line-clamp-3');
                this.innerText = 'Show more';
                gradientDiv.classList.add('show-more-gradient');
            }
        });
    });

    // functionality to show toast messages when user edit is successful
    function showToast(message, duration = 4000) {
        // Get the toast element
        const toast = document.querySelector("#toast-success");

        // Get the close button
        const closeButton = toast.querySelector("button[data-dismiss-target='#toast-success']");

        // Set the toast message
        toast.querySelector(".text-sm").innerText = message;

        // Show the toast
        toast.classList.remove("opacity-0");

         // Remove the "hidden" class if it's present
            if (toast.classList.contains("hidden")) {
                toast.classList.remove("hidden");
            }

        // Remove the toast after `duration` ms
        let timeoutId = setTimeout(() => {
            toast.classList.add("opacity-0");
        }, duration);

        // Cancel the auto-dismiss when the close button is clicked, and hide the toast
        closeButton.onclick = () => {
            console.log(toast.classList);
            clearTimeout(timeoutId);
            toast.classList.add("opacity-0");
            console.log(toast.classList);
        };
    }

    // functionality to allow user to update control's implementation status
    function updateImplementationStatus(checkbox, implementationId, choiceId) {
        const isChecked = checkbox.checked;

        fetch ('/update_implementation_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                implementation_id: implementationId,
                choice_id: choiceId,
                is_checked: isChecked,
            })
        })

        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast('The implementation status was updated successfully.');
            } else {
                console.error('There was an error updating the implementation status:', result.error);
            }
        })
        .catch(error => {
            // Handle any errors that occurred while making the fetch request
            console.error('There was an error making the fetch request:', error);
        });
    }

    // functionality to allow user to update control's origination status
    function updateOriginationStatus(checkbox, implementationId, originationId) {
        const isChecked = checkbox.checked;

        fetch ('/update_origination_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                implementation_id: implementationId,
                origination_id: originationId,
                is_checked: isChecked,
            })
        })

        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast('The origination status was updated successfully.');
            } else {
                console.error('There was an error updating the origination status:', result.error);
            }
        })
        .catch(error => {
            // Handle any errors that occurred while making the fetch request
            console.error('There was an error making the fetch request:', error);
        });
    }

</script>

{% endblock %}