{% extends "internal/internal.html" %}

{% block company %}
{{client}} <i class="fa-solid fa-mountain"></i>
{% endblock %}

{% block local_nav %}
<div class="sticky top-0 z-20 bg-white">
    <nav class="w-full py-2 px-8 border-b border-gray-200 relative">
        <div class="md:flex space-x-12" id="navbar-menu">

            <div class="md:flex md:flex-row md:items-center text-blue-500 space-x-2">
                <a href="{% url 'alchemy:index' %}" class="hover:text-blue-700 duration-300">{{client}}</a>
                <span class="text-gray-500">/</span>
                <a href="{% url 'alchemy:dashboard' system=system.name %}" class="hover:text-blue-700 duration-300">{{system.name}}</a>
                <span class="text-gray-500">/</span>
                <a href="{% url 'alchemy:implementation' system=system.name control_family=control_family %}" class="font-semibold hover:text-blue-700 duration-300">{{control_family}}</a>
            </div>
        </div>
    </nav>

    <nav class="w-full py-2 px-8 border-b border-gray-200 relative">
        <div class="w-full justify-between pr-24 md:flex md:flex-row md:items-center text-blue-500 space-x-2">
            {% for family in control_families %}
            <a href="{% url 'alchemy:implementation' system=system.name control_family=family %}" class="px-3 rounded-lg hover:bg-gray-200 hover:text-blue-700 duration-300 {% if control_family == family %}bg-gray-200{% endif %}">{{family.family_abbreviation}}</a>
            {% endfor %}
        </div>
    </nav>
</div>


        
{% endblock %}

{% block body %}

<div class="body_wrapper flex">

    <div id="sidebar-multi-level-sidebar" class="sticky top-20 left-0 w-72 h-184 border-r" aria-label="Sidebar">
        <div class="h-full px-3 overflow-y-auto dark:bg-gray-800">
            <ul class="mt-6">
                {% for implementation in control_implementations %}
                    <li id="sidebar-control-{{implementation.id}}" class="rounded-lg">
                        <a href="#control-implementation-{{implementation.id}}" class="flex text-xs items-center w-full p-2 text-gray-500 transition duration-75 rounded-lg pl-4 group hover:bg-gray-200 dark:text-white dark:hover:bg-gray-700">{{implementation.control}}: {{implementation.control.control_name}}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div id="wizard_container" class="py-8 px-12 flex flex-col min-h-screen max-w-4/5 grow">

        <div id="control_search" class="w-full mb-8">

            <div class="flex">

                <button id="search-role-dropdown-button" style="border-top-left-radius: 8px; border-bottom-left-radius: 8px;" data-dropdown-toggle="search-role-dropdown" class="flex-shrink-0 z-10 inline-flex items-center py-2.5 px-4 text-sm font-medium text-center text-gray-900 bg-gray-100 border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:focus:ring-gray-700 dark:text-white dark:border-gray-600 transition duration-200" type="button">Roles<i class="fas fa-chevron-down w-4 h-4 ml-2 transition-transform duration-200"></i></button>
                <div id="search-role-dropdown" class="dropdown p-4 z-10 hidden max-h-72 overflow-y-auto bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700">
                        
                    <div class="flex justify-center">
                        <div class="dropdown-header inline-flex rounded-md shadow-sm text-xs" role="group">
                            <button type="button" class="select-all p-2 font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700  focus:ring-2 focus:ring-blue-700 focus:text-blue-700" data-dropdown="search-role-dropdown">
                            Select All
                            </button>
                            <button type="button" style="border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem;" class="clear p-2 font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-blue-700  focus:ring-2 focus:ring-blue-700 focus:text-blue-700" data-dropdown="search-role-dropdown">
                            Clear
                            </button>
                        </div>
                    </div>
  
                    <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="search-role-dropdown-button">
                        {% for role in roles %}
                            <li>
                                <div class="flex items-center">
                                <input id="search-role-{{role.id}}" type="checkbox" value="{{role.id}}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">
                                <label for="search-role-{{role.id}}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">{{role}}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <button id="search-implementation-dropdown-button" data-dropdown-toggle="search-implementation-dropdown" class="flex-shrink-0 z-10 inline-flex items-center py-2.5 px-4 text-sm font-medium text-center text-gray-900 bg-gray-100 border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:focus:ring-gray-700 dark:text-white dark:border-gray-600 transition duration-200" type="button">Implementation Statuses<i class="fas fa-chevron-down w-4 h-4 ml-2 transition-transform duration-200"></i></button>
                <div id="search-implementation-dropdown" class="dropdown p-4 z-10 hidden max-h-72 overflow-y-auto bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700">

                    <div class="flex justify-center">
                        <div class="dropdown-header inline-flex rounded-md shadow-sm text-xs" role="group">
                            <button type="button" class="select-all p-2 font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700  focus:ring-2 focus:ring-blue-700 focus:text-blue-700" data-dropdown="search-implementation-dropdown">
                            Select All
                            </button>
                            <button type="button" style="border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem;" class="clear p-2 font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-blue-700  focus:ring-2 focus:ring-blue-700 focus:text-blue-700" data-dropdown="search-implementation-dropdown">
                            Clear
                            </button>
                        </div>
                    </div>

                    <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="search-implementation-dropdown-button">
                        {% for choice in implementation_choices %}
                            <li>
                                <div class="flex items-center">
                                <input id="search-implementation-{{choice.id}}" type="checkbox" value="{{choice.id}}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">
                                <label for="search-implementation-{{choice.id}}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">{{choice.status}}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <button id="search-origination-dropdown-button" data-dropdown-toggle="search-origination-dropdown" class="flex-shrink-0 z-10 inline-flex items-center py-2.5 px-4 text-sm font-medium text-center text-gray-900 bg-gray-100 border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:focus:ring-gray-700 dark:text-white dark:border-gray-600 transition duration-200" type="button">Originations<i class="fas fa-chevron-down w-4 h-4 ml-2 transition-transform duration-200"></i></button>
                <div id="search-origination-dropdown" class="dropdown p-4 z-10 hidden max-h-72 overflow-y-auto bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700">

                    <div class="flex justify-center">
                        <div class="dropdown-header inline-flex rounded-md shadow-sm text-xs " role="group">
                            <button type="button" class="select-all p-2 font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700  focus:ring-2 focus:ring-blue-700 focus:text-blue-700" data-dropdown="search-origination-dropdown">
                            Select All
                            </button>
                            <button type="button" style="border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem;" class="clear p-2 font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-blue-700  focus:ring-2 focus:ring-blue-700 focus:text-blue-700" data-dropdown="search-origination-dropdown">
                            Clear
                            </button>
                        </div>
                    </div>

                    <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="search-origination-dropdown-button">
                        {% for choice in origination_choices %}
                            <li>
                                <div class="flex items-center">
                                <input id="search-origination-{{choice.id}}" type="checkbox" value="{{choice.id}}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">
                                <label for="search-origination-{{choice.id}}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">{{choice.origination}}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="relative w-full">
                    <input type="search" id="search-bar" style="border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-left-color: rgb(249 250 251); border-left-width: 2px;" class="block p-2.5 w-full z-20 text-sm text-gray-900 bg-gray-50 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-l-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:border-blue-500" placeholder="Search Control Statements..." required>

                    <button type="submit" style="border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-color: rgb(29 78 216);" class="absolute top-0 right-0 p-2.5 text-sm font-medium text-white bg-blue-700 border border-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                        <svg aria-hidden="true" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <span class="sr-only">Search</span>
                    </button>
                </div>
            </div>
        </div>

        {% for implementation in control_implementations %}
            <div id="control-implementation-{{implementation.id}}" class="control w-full mb-12 border-2 p-4 rounded-lg" 
                data-implementation-id="{{implementation.id}}" 
                data-implementation-control-id="{{implementation.control.id}}"
                data-implementation-family="{{implementation.control_family.id}}" 
                data-implementation-role="{{implementation.responsible_role.id}}" 
                data-implementation-statuses="{{implementation.status_ids|join:','}}" 
                data-implementation-originations="{{implementation.origination_ids|join:','}}">
                <div id="control_header" class="flex justify-between items-center mb-6">
                    
                    <h1 class="text-xl flex-grow mr-2 font-black tracking-wide text-gray-700 overflow-x-auto whitespace-nowrap">{{implementation.control}} | {{implementation.control.control_name }}</h1>

                    <div id="control_context" class="flex">
                        <div id="control_owner" class="mr-2">
                            <button id="owner-dropdown-button-{{implementation.id}}" data-dropdown-toggle="owner-dropdown-helper-{{implementation.id}}" class="{% if implementation.responsible_role %} text-white bg-blue-500 hover:bg-blue-700 {% else %} min-w-44 text-blue-500 bg-white border border-blue-500 hover:bg-gray-100 {% endif %} focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-1 text-center inline-flex overflow-x-auto text-ellipsis whitespace-nowrap items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 transition duration-200" type="button">
                                <span class="button-text">
                                    {% if implementation.responsible_role %}
                                        {{implementation.responsible_role}}
                                    {% else %}
                                        Responsible Role
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        
                            <!-- Dropdown menu --->
                            <div id="owner-dropdown-helper-{{implementation.id}}" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-48 dark:bg-gray-700 dark:divide-gray-600">
                                <ul class="role-list max-h-48 p-2 overflow-y-auto text-sm text-gray-700 dark:text-gray-200" aria-labelledby="owner-dropdown-button-{{implementation.id}}">
                                    <!-- To be populated by API call -->
                                </ul>
                                <div class="flex items-center p-3 text-sm font-medium text-blue-600 border-t border-gray-200 rounded-b-lg bg-gray-50 dark:border-gray-600 hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-blue-500">
                                    <i class="mr-2 fa-solid fa-plus hover:cursor-pointer" onclick="addRole(event, {{implementation.id}})"></i>
                                    <div>
                                        <input type="text" id="add_role_input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full px-2 py-1 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Add new role">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="control_status" class="mr-2">
                            <button id="status-dropdown-button-{{implementation.id}}" data-dropdown-toggle="status-dropdown-helper-{{implementation.id}}" class="{% with statuses=implementation.statuses.all %}{% if statuses %}text-white bg-blue-500 hover:bg-blue-700 {% else %} text-blue-500 bg-white border border-blue-500 hover:bg-gray-100 {% endif %} {% endwith %} focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-1 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 transition duration-200 max-w-xs overflow-x-auto text-ellipsis whitespace-nowrap" type="button">
                                <span class="button-text">
                                    {% with statuses=implementation.statuses.all %}
                                        {% if statuses %}
                                            {{ statuses|join:", " }}
                                        {% else %}
                                            Implementation Status
                                        {% endif %}
                                    {% endwith %}
                                </span>
                                <svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        
                            <!-- Dropdown menu --->
                            <div id="status-dropdown-helper-{{implementation.id}}" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700 dark:divide-gray-600">
                                <ul class="p-3 space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="status-dropdown-button-{{implementation.id}}">
                                    {% for choice in implementation_choices %}
                                        <li>
                                            <div class="flex items-center">
                                                <input id="implementation-checkbox-{{implementation.id}}-{{choice.id}}" type="checkbox" value="{{choice.status}}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" onchange="updateImplementationStatus(this, {{implementation.id}}, {{choice.id}})" required=""
                                                {% for status in implementation.statuses.all %}
                                                    {% if status.id == choice.id %}
                                                        checked
                                                    {% endif %}
                                                {% endfor %}>
                                                <label for="implementation-checkbox-{{implementation.id}}-{{choice.id}}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">{{choice.status}}</label>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <div id="control_origination">
                            <button id="origination-dropdown-button-{{implementation.id}}" data-dropdown-toggle="origination-dropdown-helper-{{implementation.id}}" class="{% with originations=implementation.originations.all %}{% if originations %}text-white bg-blue-500 hover:bg-blue-700 {% else %} text-blue-500 bg-white border border-blue-500 hover:bg-gray-100 {% endif %} {% endwith %} focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-1 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 transition duration-200 max-w-xs overflow-x-auto text-ellipsis whitespace-nowrap" type="button">
                                <span class="button-text">
                                    {% with originations=implementation.originations.all %}
                                        {% if originations %}
                                            {{ originations|join:", " }}
                                        {% else %}
                                            Control Origination
                                        {% endif %}
                                    {% endwith %}
                                </span>
                                <svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        
                            <!-- Dropdown menu --->
                            <div id="origination-dropdown-helper-{{implementation.id}}" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700 dark:divide-gray-600">
                                <ul class="origination-list p-3 space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="origination-dropdown-button-{{implementation.id}}">
                                    <!-- To be populated by API call -->
                                </ul>   
                            </div>
                        </div>
                    </div>
                </div>

                <div id="control_requirement">
                    <div id="control_description-{{implementation.control.id}}" class="text-gray-700 mb-2">
                        <p>{{implementation.control.control_description}}</p>
                    </div>
            
                    {% for part in implementation.control.parts.all %}
                        <div id="control_part_description-{{part.id}}" class="flex text-gray-700 mb-2">
                            <span class="mr-2 font-black tracking-wide text-gray-700">{{part.part_letter}}. </span><p>{{part.part_description}}</p>
                        </div>
                    {% endfor %}                   
                </div>
                    
                <div id="control_statements" class="mt-6">
                    {% for statement in implementation.control_statement_parts.all %}
                        <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                            <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                <div class="flex flex-wrap items-center dark:divide-gray-600">
                                    <div class="flex items-center space-x-1 sm:pr-4">
                                        <label for="question-answer" class="mr-2 font-black tracking-wide text-gray-500">{{ statement.control_part.part_letter }}.</label>
                
                                        <button type="button" class="p-2 text-blue-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600" data-id="{{ implementation.control.id }}" onclick="openAICall(event, {{ implementation.id }}, {{ implementation.control.id }}, {{ system.id }}, '{{ implementation.control.control_description|escapejs }}', '{{ statement.control_part.part_description|escapejs }}', {{ statement.control_part.id }})">
                                            <i class="fa-solid fa-wand-magic-sparkles w-5 h-5"></i>
                                            <span class="sr-only">Generate AI Text</span>
                                        </button>
                
                                        <button type="button" class="flex ml-auto p-2 text-blue-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                            <i class="fa-regular fa-copy fa-lg"></i>
                                            <span class="sr-only">Copy text</span>
                                        </button>
                            
                                        <button type="button" class="p-2 text-blue-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600" onclick="updateControlText({{ implementation.id }}, {{ statement.control_part.id }})">
                                            <i class="far fa-save fa-lg"></i>
                                            <span class="sr-only">Save Text</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                
                            <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                <textarea id="statement-text-{{ statement.control_part.id }}" rows="4" class="question-answer block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400" placeholder="Write your statement here..."
                                data-part-id="{{ statement.control_part.id }}"
                                data-implementation-text="{{ statement.statement }}">{{ statement.statement }}</textarea>
                            </div>
                        </div>
                    {% empty %}
                    <div id="statement-general-{{implementation.id}}" class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                            <div class="flex flex-wrap items-center dark:divide-gray-600">
                                
                                <div class="flex items-center space-x-1 sm:pr-4">

                                    <button type="button" class="p-2 text-blue-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600" data-implementation="{{implementation.id}}" data-id="{{implementation.control.id}}" onclick="openAICall(event, {{implementation.id}}, {{implementation.control.id}}, {{system.id}}, '{{implementation.control.control_description|escapejs}}', '', 'General')">
                                        <i class="fa-solid fa-wand-magic-sparkles w-5 h-5"></i>
                                        <span class="sr-only">Generate AI Text</span>
                                    </button>

                                    <button class="flex ml-auto p-2 text-blue-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                        <i class="fa-regular fa-copy fa-lg"></i>
                                        <span class="sr-only">Copy text</span>
                                    </button>

                                    <button type="button" class="p-2 text-blue-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600" data-id="{{implementation.control.id}}" onclick="updateControlText({{implementation.id}}, 'General')">
                                        <i class="far fa-save fa-lg"></i>
                                        <span class="sr-only">Save Text</span>
                                    </button>
                                </div>
                                
                            </div>
                            
                        </div>

                        <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                            <textarea id="statement-text-general-{{implementation.id}}" rows="4" class="question-answer block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400" placeholder="Write your statement here..."
                            data-part-id="General"
                            data-implementation-text="{{implementation.statement}}">{{implementation.statement}}</textarea>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="control_guidance" class="mt-4">
                    <div id="accordion-flush" data-accordion="open" data-active-classes="text-white bg-blue-500" data-inactive-classes="text-gray-500">
    
                        <div id="accordion-guidance-element-{{implementation.control.id}}">
                            <h2 id="accordion-guidance-heading-{{implementation.control.id}}">
                                <button type="button" class="flex items-center justify-between w-full px-4 py-2 rounded-t-lg font-medium text-left text-gray-500" data-accordion-target="#accordion-guidance-body-{{implementation.control.id}}" aria-expanded="false" aria-controls="accordion-guidance-body-{{implementation.control.id}}">
                                    <span class="text-xl font-bold transition-transform duration-200">Supplemental Guidance</span> 
                                    <i data-accordion-icon class="fas fa-chevron-down w-6 h-6 transition-transform duration-200"></i>
                                </button>
                            </h2>
                            <div id="accordion-guidance-body-{{implementation.control.id}}" class="px-4 mt-2 hidden" aria-labelledby="accordion-guidance-heading-{{implementation.control.id}}">
                                <div class="px-8 py-6 ">
                                    <p class="mb-2 text-gray-500">{{implementation.control.supplemental_guidance}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <div id="toast-success" class="fixed transition opacity-0 duration-300 bottom-4 flex items-center w-96 p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
            <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 mr-2 text-green-500 bg-green-100 rounded-lg dark:bg-green-800 dark:text-green-200">
                <i class="fas fa-check"></i>
                <span class="sr-only">Check icon</span>
            </div>
            
            <div class="ml-3 text-sm font-normal"></div>
            <button type="button" class="flex justify-center items-center ml-2 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-success" aria-label="Close">
                <span class="sr-only">Close</span>
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        
        <button id ="scrollButton" class="fixed right-8 bottom-8 bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hidden">
            <i id="scrollIcon" class="fas fa-chevron-up"></i>
        </button>
    </div>
</div>
  
<!-- Javascript for interactive aspects of the onboarding wizard -->
<script type="text/javascript">

    // Scrolling function for category selection view. When the circular scroll button in bottom right is clicked, it will either scroll down or up to show more of the categories
    document.getElementById("scrollButton").addEventListener("click", function() {
        const scrollButton = document.getElementById("scrollButton");
    });

    // Add a scroll event listener to the window to show the scroll button once a user has started scrolling.
    window.addEventListener("scroll", () => {
        if (window.pageYOffset > 1000) {
            // If the user has started scrolling, show the scroll button.
            scrollButton.classList.remove("hidden");
        } else {
            // If the user has scrolled back to the top, hide the scroll button.

            scrollButton.classList.add("hidden");
        }
    });

    // Modify the click event listener on the scroll button to always scroll the page back to the top.
    scrollButton.addEventListener("click", function() {
        window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Functionality for show more/show less text expansion/compression and fade in/out
    document.querySelectorAll('.show-more-less-btn').forEach((btn) => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const descriptionDiv = document.querySelector('#control_description-' + id);
            const gradientDiv = descriptionDiv.querySelector('#show-gradient');
            if (this.innerText === 'Show more') {
                descriptionDiv.classList.remove('line-clamp-3');
                this.innerText = 'Show less';
                gradientDiv.classList.remove('show-more-gradient');
            } else {
                descriptionDiv.classList.add('line-clamp-3');
                this.innerText = 'Show more';
                gradientDiv.classList.add('show-more-gradient');
            }
        });
    });

    // functionality to show toast messages when user edit is successful
    function showToast(message, duration = 4000) {
        // Get the toast element
        const toast = document.querySelector("#toast-success");

        // Get the close button
        const closeButton = toast.querySelector("button[data-dismiss-target='#toast-success']");

        // Set the toast message
        toast.querySelector(".text-sm").innerText = message;

        // Show the toast
        toast.classList.remove("opacity-0");

         // Remove the "hidden" class if it's present
            if (toast.classList.contains("hidden")) {
                toast.classList.remove("hidden");
            }

        // Remove the toast after `duration` ms
        let timeoutId = setTimeout(() => {
            toast.classList.add("opacity-0");
        }, duration);

        // Cancel the auto-dismiss when the close button is clicked, and hide the toast
        closeButton.onclick = () => {
            clearTimeout(timeoutId);
            toast.classList.add("opacity-0");
        };
    }
    // <!-- text-white bg-blue-500 hover:bg-blue-700 --> 
    // <!-- text-blue-500 bg-white border border-blue-500 hover:bg-gray-100 -->

    // functionality to allow user to update control's implementation status
    function updateImplementationStatus(checkbox, implementationId, choiceId) {
        const isChecked = checkbox.checked;

        fetch ('/update_implementation_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                implementation_id: implementationId,
                choice_id: choiceId,
                is_checked: isChecked,
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast('The implementation status was updated successfully.');

                // Update the parent-level control implementation responsible implemented statuseses data attribute
                const controlImplementationDiv = document.querySelector(`#control-implementation-${implementationId}`);
                controlImplementationDiv.dataset.implementationStatuses = result.updated_statuses_ids

                // Update the button text
                const button = document.querySelector(`#status-dropdown-button-${implementationId}`);
                const button_text = document.querySelector(`#status-dropdown-button-${implementationId} .button-text`);
                button_text.textContent = result.updated_statuses_names.join(", ") || "Implementation Status";

                if (result.updated_statuses_names.length > 0){
                    // Change button color to blue if there are any statuses
                    button.classList.remove("bg-white", "text-blue-500", "border", "border-blue-500", "hover:bg-gray-100");
                    button.classList.add("text-white", "bg-blue-500", "hover:bg-blue-700");
                } else {
                    // Change button color to white if there are no statuses
                    button.classList.add("bg-white", "text-blue-500", "border", "border-blue-500", "hover:bg-gray-100");
                    button.classList.remove("text-white", "bg-blue-500", "hover:bg-blue-700");
                }

            } else {
                console.error('There was an error updating the implementation status:', result.error);
            }
        })
        .catch(error => {
            // Handle any errors that occurred while making the fetch request
            console.error('There was an error making the fetch request:', error);
        });
    }

    // functionality to allow user to update control's origination status
    function updateOriginationStatus(checkbox, implementationId, originationId) {
        const isChecked = checkbox.checked;

        fetch ('/update_origination_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                implementation_id: implementationId,
                origination_id: originationId,
                is_checked: isChecked,
            })
        })

        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast('The origination status was updated successfully.');

                // Update the parent-level control implementation responsible implemented statuseses data attribute
                const controlImplementationDiv = document.querySelector(`#control-implementation-${implementationId}`);
                controlImplementationDiv.dataset.originationStatuses = result.updated_originations_ids;

                // Update the button text
                const button = document.querySelector(`#origination-dropdown-button-${implementationId}`);
                const button_text = document.querySelector(`#origination-dropdown-button-${implementationId} .button-text`);
                button_text.textContent = result.updated_originations_names.join(", ") || "Control Origination";

                if (result.updated_originations_names.length > 0){
                    // Change button color to blue if there are any statuses
                    button.classList.remove("bg-white", "text-blue-500", "border", "border-blue-500", "hover:bg-gray-100");
                    button.classList.add("text-white", "bg-blue-500", "hover:bg-blue-700");
                } else {
                    // Change button color to white if there are no statuses
                    button.classList.add("bg-white", "text-blue-500", "border", "border-blue-500", "hover:bg-gray-100");
                    button.classList.remove("text-white", "bg-blue-500", "hover:bg-blue-700");
                }

            } else {
                console.error('There was an error updating the origination status:', result.error);
            }
        })
        .catch(error => {
            // Handle any errors that occurred while making the fetch request
            console.error('There was an error making the fetch request:', error);
        });
    }

    // functionality to allow user to update control's responsible role
    function updateResponsibleRole(radio, implementationId, roleId) {
        const isChecked = radio.checked;

        fetch ('/update_responsible_role', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                implementation_id: implementationId,
                role_id: roleId,
                is_checked: isChecked,
            })
        })

        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast('The responsible role was updated successfully.');

                // Update the parent-level control implementation responsible role data attribute
                const controlImplementationDiv = document.querySelector(`#control-implementation-${implementationId}`);
                controlImplementationDiv.dataset.implementationRole = result.updated_role_id;

                // Update the button text
                const button = document.querySelector(`#owner-dropdown-button-${implementationId}`);
                const button_text = document.querySelector(`#owner-dropdown-button-${implementationId} .button-text`);
                button_text.textContent = result.updated_role_name || "Responsible Role";
                
                if (result.updated_role_name.length > 0){
                    // Change button color to blue if there are any statuses
                    button.classList.remove("bg-white", "text-blue-500", "border", "border-blue-500", "hover:bg-gray-100", "min-w-44");
                    button.classList.add("text-white", "bg-blue-500", "hover:bg-blue-700");
                } else {
                    // Change button color to white if there are no statuses
                    button.classList.add("bg-white", "text-blue-500", "border", "border-blue-500", "hover:bg-gray-100",  "min-w-44");
                    button.classList.remove("text-white", "bg-blue-500", "hover:bg-blue-700");
                }

            } else {
                console.error('There was an error updating the responsible role:', result.error);
            }
        })
        .catch(error => {
            // Handle any errors that occurred while making the fetch request
            console.error('There was an error making the fetch request:', error);
        });
    }

    // functionality to allow user to add a responsible role to the overall list in the database
    function addRole(event, implementationId) {

        let input = event.target.parentElement.querySelector('#add_role_input');
        let role_name = input.value;

        if (role_name.length > 0) {
            fetch ('/add_role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    role_name: role_name,
                })
            })

            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    showToast('The responsible role was successfully added.');

                    // create new dropdownHtml for new role
                    let dropdownHtml = `
                        <li class="p-2">
                            <input id="role_radio-${implementationId}-${result.role_id}" name="helper-radio-${implementationId}" type="radio" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" onchange="updateResponsibleRole(this, ${implementationId}, ${result.role_id})" checked>
                            <label for="role_radio-${implementationId}-${result.role_id}" class="font-medium ml-2 dark:text-gray-300 team-option">${result.role_name}</label>
                        </li>`;

                    // Append the new role to the ul
                    const roleList = document.querySelector(`#owner-dropdown-helper-${implementationId} .role-list`);
                    roleList.innerHTML += dropdownHtml;

                    // update the button text
                    const buttonText = document.querySelector(`#owner-dropdown-button-${implementationId} .button-text`);
                    buttonText.textContent = result.role_name;
                    
                    // clear the input
                    input.value = '';
                } else {
                    console.error('There was an error adding the responsible role:', result.error);
                }
            })


            .catch(error => {
                // Handle any errors that occurred while making the fetch request
                console.error('There was an error making the fetch request:', error);
            });
        }
    }

    function openAICall(event, implementationId, control, system, descriptionBase, descriptionPart, part) {

        showToast('Generating control implementation language...');

        // Fetch API call to Django URL
        fetch('/generate_ai_statement', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                'control': control,
                'system': system,
                'description_base': descriptionBase,
                'description_part': descriptionPart
            })
        })
        
        .then(response => response.json())
        .then(result => {
            showToast('The control implementation language was generated successfully.');
            // On success, update the textarea with the returned text
            // Please adjust this selector to target the correct textarea based on your HTML structure

            if (part != 'General') {
                document.querySelector(`#statement-text-${part}`).value = result.output;
            } else {
                document.querySelector(`#statement-text-general-${implementationId}`).value = result.output;
            }
        })
        .catch(error => console.log('Error:', error));
    }

    // Updates the new statement for a control implementation when a user clicks save
    function updateControlText(implementationId, partId) {

        let statement;

        let divId = `statement-text-`;

        if (partId == 'General') {
            statement = document.querySelector(`#statement-text-general-${implementationId}`).value;
            divId += `general-${implementationId}`;
        }

        else {
            statement = document.querySelector(`#statement-text-${partId}`).value;
            divId += `${partId}`;
        }

        // Fetch API call to Django URL
        fetch('/save_control_text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                'implementation_id': implementationId,
                'part_id': partId,
                'statement': statement,
            })
        })

        .then(response => response.json())
        .then(result => {
            // Access the implementation div
            let implementationDiv = document.getElementById(divId);
            implementationDiv.dataset.implementationText = result.updated_statement;

            showToast('The control implementation language was saved successfully.');
            
        })
        .catch(error => console.log('Error:', error));
    }

    // SEARCH AREA FUNCTIONALITY  ---------------------------------------------------

    // Filter object for dropdown selections
    let filters = {
        'search-role-dropdown': [],
        'search-origination-dropdown': [],
        'search-implementation-dropdown': []
    };

    // Function to determine if a control should be visible or not
    function shouldShowControl(control) {
        // Dropdown filters
        const shouldShowForDropdown = Object.keys(filters).every(dropdownId => {
            let attribute = '';

            switch(dropdownId) {
                case 'search-role-dropdown':
                    attribute = 'data-implementation-role';
                    break;
                case 'search-origination-dropdown':
                    attribute = 'data-implementation-originations';
                    break;
                case 'search-implementation-dropdown':
                    attribute = 'data-implementation-statuses';
                    break;
                default:
                    console.log('Unexpected dropdown id: ' + dropdownId);
                    return true;
            }

            const controlAttrValue = control.getAttribute(attribute);
            const selectedIdsForDropdown = filters[dropdownId];

            if (selectedIdsForDropdown.length === 0) {
                return true;
            }

            if (attribute === 'data-implementation-role' || attribute === 'data-implementation-family') {
                return selectedIdsForDropdown.includes(controlAttrValue);
            } else {
                const controlValues = controlAttrValue.split(',');
                return selectedIdsForDropdown.some(id => controlValues.includes(id));
            }
        });

        // Search bar filter
        const searchPhrase = document.getElementById('search-bar').value.toLowerCase();
        let childElements = control.querySelectorAll('[data-implementation-text]');
        let found = false;
        for(let child of childElements) {
            let controlText = child.dataset.implementationText.toLowerCase();
            if(controlText.indexOf(searchPhrase) !== -1) {
                found = true;
                break;
            }
        }
        
        return shouldShowForDropdown && found;
    }

    // Event listeners for dropdown filters
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        dropdown.addEventListener('change', event => {
            const selectedIds = Array.from(dropdown.querySelectorAll('input:checked')).map(input => input.value);
            filters[dropdown.id] = selectedIds;

            document.querySelectorAll('.control').forEach(control => {
                control.classList.toggle('hidden', !shouldShowControl(control));
            });

            checkFilterStatus(dropdown);
        });
    });

    // Event listener for search bar
    document.getElementById('search-bar').addEventListener('input', function(e) {
        document.querySelectorAll('.control').forEach(control => {
            control.classList.toggle('hidden', !shouldShowControl(control));
        });
    });

    // Add event listeners for "Select All" and "Clear" buttons
    document.querySelectorAll('.select-all').forEach(selectAllButton => {
        selectAllButton.addEventListener('click', event => {
            const dropdownId = event.target.getAttribute('data-dropdown');
            const dropdown = document.getElementById(dropdownId);
            dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            checkFilterStatus(dropdown); // Check filter status
            handleFilterChange({currentTarget: dropdown}); // Trigger filter update
        });
    });

    document.querySelectorAll('.clear').forEach(clearButton => {
        clearButton.addEventListener('click', event => {
            const dropdownId = event.target.getAttribute('data-dropdown');
            const dropdown = document.getElementById(dropdownId);

            // Uncheck all checkboxes first
            dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Check filter status after unchecking
            checkFilterStatus(dropdown);

            // Then handle filter change
            handleFilterChange({currentTarget: dropdown});
        });
    });


    // Changes color of search buttons if a checkbox is selected for better user visibility
    function checkFilterStatus(dropdown) {
        const id = dropdown.getAttribute('id');
        const button = document.querySelector(`button[data-dropdown-toggle="${id}"]`);
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
        let isChecked = false;

        checkboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                isChecked = true;
            }
        });

        if (isChecked) {
            button.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-700');
            button.classList.remove('bg-gray-100', 'text-gray-900', 'hover:bg-gray-200');
        } else {
            button.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-700');
            button.classList.add('bg-gray-100', 'text-gray-900', 'hover:bg-gray-200');
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
  
        // grab all the control elements on the page
        let controls = document.querySelectorAll('.control');

        let observerOptions = { threshold: 0.5 };

        // setup an intersection observer to handle when controls come into view
        let observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    let implementationId = entry.target.getAttribute('data-implementation-id');
                    let familyId = entry.target.getAttribute('data-implementation-family');

                    // collapse all families in the sidebar
                    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });

                    // remove highlight from all family and control labels
                    document.querySelectorAll('.family-nav li').forEach(item => {
                        item.classList.remove('bg-gray-200');
                    });

                    // expand the current family in the sidebar and don't highlight it
                    let currentDropdown = document.querySelector('#dropdown-' + familyId);
                    currentDropdown.classList.remove('hidden');

                    // highlight the current control in the sidebar
                    let currentControl = document.querySelector('#sidebar-control-' + implementationId);
                    currentControl.classList.add('bg-gray-200');

                    // ensure highlighted control is visible in the sidebar dropdown
                    let dropdownHeight = currentDropdown.getBoundingClientRect().height;
                    currentDropdown.scrollTop = (currentControl.offsetTop - currentDropdown.offsetTop) - dropdownHeight/2 + currentControl.getBoundingClientRect().height/2;
                }
            });
        }, observerOptions); // adjust threshold as needed

        document.querySelectorAll('.family-nav a').forEach(a => {
            a.addEventListener('click', function(e) {
                e.preventDefault();

                observer.disconnect();

                // Get the ID of the target element from the href attribute of the clicked link
                let targetId = this.getAttribute('href').slice(1);

                // Get the target element
                let target = document.getElementById(targetId);

                // Get the position to scroll to (this is where you can add some padding)
                let positionToScrollTo = target.offsetTop - 50;  // adjust this value as needed

                // Scroll to the position
                window.scrollTo({
                    top: positionToScrollTo,
                    behavior: 'smooth'  // this makes the scrolling animate smoothly
                });

                setTimeout(function() {
                    // observe all the controls
                    controls.forEach(control => {
                        observer.observe(control);
                    });
                }, 1000); // adjust delay as needed
            });
        });

        // initially observe all the controls
        controls.forEach(control => {
            observer.observe(control);
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        
        fetch('/api/get_roles/')
        .then(response => response.json())
        .then(data => {
            const roleElements = document.querySelectorAll(".role-list");
            
            roleElements.forEach(roleList => {
                let parentDiv = roleList.closest('.control');
                let implementationId = parentDiv.dataset.implementationId;
                let dropdownHtml = '';
                
                data.forEach(role => {
                    dropdownHtml += `
                        <li class="p-2">
                            <input id="role_radio-${implementationId}-${role.id}" name="helper-radio-${implementationId}" type="radio" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" onchange="updateResponsibleRole(this, ${implementationId}, ${role.id})">
                            <label for="role_radio-${implementationId}-${role.id}" class="font-medium ml-2 dark:text-gray-300 team-option">${role.responsible_role}</label>
                        </li>`;
                });
                
                roleList.innerHTML = dropdownHtml;
            });
        });

        fetch('/api/get_originations/')
        .then(response => response.json())
        .then(data => {
            const originationElements = document.querySelectorAll(".origination-list");
            
            originationElements.forEach(originationList => {
                let parentDiv = originationList.closest('.control');
                let implementationId = parentDiv.dataset.implementationId;
                let implementationOriginations = parentDiv.dataset.implementationOriginations.split(',');
            
                let dropdownHtml = '';

                data.forEach(origination => {
                    let isChecked = implementationOriginations.includes(origination.id.toString()) ? 'checked' : '';
                
                    dropdownHtml += `
                        <li>
                            <div class="flex items-center">
                            <input id="origination-checkbox-${implementationId}-${origination.id}" type="checkbox" value="${origination.id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" onchange="updateOriginationStatus(this, ${implementationId}, ${origination.id})" required ${isChecked}>
                            <label for="origination-checkbox-${implementationId}-${origination.id}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">${origination.origination}</label>
                            </div>
                        </li>`;
                    });
                
                originationList.innerHTML = dropdownHtml;
            });
        });

    });

    document.querySelectorAll('#sidebar-multi-level-sidebar a').forEach((a) => {
        a.addEventListener('click', function(event) {
            event.preventDefault();

            // Get the target element
            let targetId = this.getAttribute('href');
            let targetElement = document.querySelector(targetId);

            // Get the height of your navbar. Adjust '60' to match your navbar's height.
            let navbarHeight = 100;

            // Scroll to the element, minus the navbar height
            window.scrollTo({
                top: targetElement.offsetTop - navbarHeight,
                behavior: 'smooth'
            });
        });
    });

</script>

{% endblock %}